#!/bin/bash -e
#
# Build CyberArk sidecar injector mutating webhook service
# usage: ./bin/build
set -ex

cd "$(dirname "${0}")"
. ./build_utils
cd ..

readonly IMAGE_NAME="sidecar-injector"

function main() {
  retrieve_cyberark_ca_cert
  build_docker_image
}

function build_docker_image() {
  VERSION=unreleased
  # Version derived from CHANGELOG and automated release library
  [ -f VERSION ] && VERSION=$(<VERSION)
  FULL_VERSION_TAG="$VERSION-$(git_commit_short)"

  docker build \
    --build-arg "GIT_COMMIT_SHORT=$(git_commit_short)" \
    --build-arg "VERSION=$VERSION" \
    -t "${IMAGE_NAME}:latest" \
    -t "${IMAGE_NAME}:${FULL_VERSION_TAG}" \
    .
}

main
